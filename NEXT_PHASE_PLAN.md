# 次期開発フェーズ計画

## 🎯 現状評価と課題

### 実装状況サマリー
- **フェーズ1 (基盤構築)**: ✅ 100% 完了
- **フェーズ2 (コア機能)**: 🔄 80% 完了 (APIリファクタ必要)
- **フェーズ3+ (拡張機能)**: ❌ 未着手

### 🚨 主要課題
1. **API設計の不整合**: 現在はイベント駆動、新仕様はシンプルAPI
2. **メソッド名の不一致**: `execute()` vs `parse()`, `finish()` vs `parseComplete()`
3. **不要なイベントシステム**: `on()`, `off()` メソッドが新仕様に不要

## 📅 次期開発計画

### 🏃‍♂️ フェーズ2.5: API統一化 (優先度: 最高、期間: 1週間)

#### 目標
既存の動作する実装を新API仕様に適合させ、シンプルで使いやすいインターフェースを実現

#### 主要タスク

##### 2.5.1 APIメソッド名変更
- **緊急度**: 最高
- **作業内容**:
  - [ ] `execute()` → `parse()` メソッド名変更
  - [ ] `finish()` → `parseComplete()` メソッド名変更
  - [ ] 内部実装は既存ロジックを活用
  - [ ] テストファイルを新APIに対応

##### 2.5.2 イベントシステム除去
- **緊急度**: 高
- **作業内容**:
  - [ ] `on()`, `off()` メソッドの削除
  - [ ] コールバック管理機能の除去
  - [ ] イベント定数クラスの削除
  - [ ] ヘッダーファイルのクリーンアップ

##### 2.5.3 直接データアクセス強化
- **緊急度**: 高
- **作業内容**:
  - [ ] `getHeader(string $name): ?string` 実装
  - [ ] `isComplete(): bool` 実装
  - [ ] `getState(): int` 実装
  - [ ] 既存 `getHeaders()` の最適化

### 🔧 フェーズ3: 機能拡張 (優先度: 高、期間: 1-2週間)

#### 3.1 ボディ処理実装
- **目標**: HTTP ボディデータの効率的な処理
- **タスク**:
  - [ ] `getBody(): string` 実装
  - [ ] ボディデータの内部蓄積機能
  - [ ] 大きなボディの効率的な管理
  - [ ] メモリ使用量の最適化

#### 3.2 URL/URI 処理
- **目標**: リクエスト URL の解析とアクセス
- **タスク**:
  - [ ] `getUrl(): string` 実装
  - [ ] URL コンポーネントの解析
  - [ ] クエリパラメータアクセス (将来拡張)

#### 3.3 状態管理改善
- **目標**: パーサーの再利用性向上
- **タスク**:
  - [ ] `reset(): void` 実装
  - [ ] 状態クリア機能の強化
  - [ ] パーサー再利用の動作確認

### 🛡️ フェーズ4: エラーハンドリング (優先度: 中、期間: 1週間)

#### 4.1 例外システム構築
- **タスク**:
  - [ ] `Llhttp\ParseException` クラス実装
  - [ ] `Llhttp\ErrorCodes` クラス実装
  - [ ] エラー位置特定機能
  - [ ] 詳細なエラーメッセージ

#### 4.2 エラー回復機能
- **タスク**:
  - [ ] パーシャルデータ処理
  - [ ] エラー後の状態管理
  - [ ] 回復可能エラーの識別

## 🛠️ 具体的な実装戦略

### 段階1: 最小限のAPI統一 (1-2日)

```php
// 現在 (動作確認済み)
$parser->execute($data);
$parser->finish();

// 目標 (同じ内部実装)
$parser->parse($data);
$parser->parseComplete();
```

**実装方針**:
1. 内部実装は変更せず、メソッド名のみ変更
2. 下位互換性は考慮しない (新API専用)
3. 既存のテストを修正して動作確認

### 段階2: 直接アクセス機能追加 (2-3日)

```php
// 新機能実装
$contentType = $parser->getHeader('Content-Type');
$isComplete = $parser->isComplete();
$body = $parser->getBody();
$url = $parser->getUrl();
```

**実装方針**:
1. 既存の内部データ構造を活用
2. 新しいメソッドは段階的に追加
3. エラーハンドリングは基本的なもののみ

### 段階3: 最適化とクリーンアップ (2-3日)

**作業内容**:
1. イベントシステムコードの完全除去
2. 不要なヘッダーファイル定義の削除
3. メモリ使用量の最適化
4. パフォーマンス測定

## 📋 作業優先順位

### Week 1: API統一化完了
1. **Day 1-2**: メソッド名変更とテスト修正
2. **Day 3-4**: 直接アクセス機能追加
3. **Day 5-7**: イベントシステム除去とクリーンアップ

### Week 2: 機能拡張
1. **Day 1-3**: ボディ処理実装
2. **Day 4-5**: URL処理実装
3. **Day 6-7**: 状態管理改善

### Week 3: 品質向上
1. **Day 1-3**: エラーハンドリング実装
2. **Day 4-5**: テスト強化
3. **Day 6-7**: ドキュメント更新

## 🎯 成功指標

### 技術指標
- [ ] 新API仕様への100%準拠
- [ ] 既存機能の動作継続
- [ ] メモリリーク0件
- [ ] パフォーマンス劣化なし

### ユーザビリティ指標
- [ ] シンプルなAPI (メソッド数 < 15)
- [ ] 直感的なメソッド名
- [ ] 型安全性の確保
- [ ] 明確なエラーメッセージ

## 🚀 次のアクション

### 即座に開始すべき作業
1. **APIメソッド名変更** - 最低限の労力で最大の効果
2. **基本テストの修正** - 動作確認継続
3. **不要コードの特定** - イベントシステム除去準備

### 計画承認後の作業
1. **詳細実装計画の策定**
2. **マイルストーン設定**
3. **進捗追跡システム構築**

---

**この計画により、既存の堅牢な実装を基盤として、新API仕様に準拠した高性能HTTP パーサーを効率的に完成させることができます。**